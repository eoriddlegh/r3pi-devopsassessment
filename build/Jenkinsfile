node {
    environment {
        DOCKERIMGNAME = 'r3pidokku/sample-node-app'
        DOKKU_URL = 'sample-node-app.r3pidokku'
        APPVERSION = '0.0.1'
        SRVRPORT   = '3000'
    }
    stage('Build') {
        echo 'print out docker version'
        sh 'docker --version'
        // TODO cd to git repo working folder
        sh 'docker build -t ${env.DOCKERIMGNAME}:${env.APPVERSION} .'
    }
    stage('SmokeTest') {
        sh 'docker run -p ${env.SRVRPORT}:3000 -d ${env.DOCKERIMGNAME}:${env.APPVERSION}'
        sh 'curl http://localhost:${env.SRVRPORT} | grep "<title>R3PI</title>"'
    }
    stage('PushToDokku') {
        // TODO cd to git repo working folder
        sh 'git push dokku master'
    }
    stage('TestOnDokku') {
        sh 'curl http://${env.DOKKU_URL} | grep "<title>R3PI</title>"'
    }
}

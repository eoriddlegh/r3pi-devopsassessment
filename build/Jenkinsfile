node {
    environment {
        DOCKERIMGNAME = 'r3pidokku/sample-node-app'
        DOKKU_URL = 'sample-node-app.r3pidokku'
        /*
         ** Ideally these vars be set at Jenkins job level and passed down as environment / build parameters.
         ** This way multiple docker containers can be run in parallel testing away on a CI server to ensure that every commit
         ** does not break the smoke test.
         ** APPVERSION can be JIRA-ID or Sprint Version or just set it to jenkins ${env.BUILD_NUMBER}
         */
        APPVERSION = '0.0.1"
        // OR
        // APPVERSION = '0.1.${env.BUILD_NUMBER}'
        SRVRPORT   = '3000'
    }
    stage('Build') {
        echo 'print out docker version'
        sh 'docker --version'
        // TODO cd to git repo working folder
        sh 'docker build -t ${env.DOCKERIMGNAME}:${env.APPVERSION} .'
    }
    stage('SmokeTest') {
        sh 'docker run -p ${env.SRVRPORT}:3000 -d ${env.DOCKERIMGNAME}:${env.APPVERSION}'
        sh 'curl http://localhost:${env.SRVRPORT} | grep "<title>R3PI</title>"'
    }
    stage('PushToDokku') {
        // TODO cd to git repo working folder
        sh 'git push dokku master'
    }
    // stage TestOnDokku is a more rigourous test of app.
    // This is where test cases for the hotfix or feature is tested and if passed it 
    // may be a potential RELEASE-CANDIDATE build for release to production.
    stage('TestOnDokku') {
        sh 'curl http://${env.DOKKU_URL} | grep "<title>R3PI</title>"'
    }
}
